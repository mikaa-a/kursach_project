{% extends "base.html" %}
{% block page_title %}Распределение товара{% endblock %}
{% block content %}
<div class="card">
  <h3>Отправить товар</h3>
  <div class="form-group">
    <label>Откуда (склад):</label>
    <select id="from-warehouse">
      <option value="">— выберите —</option>
    </select>
  </div>
  <div class="form-group">
    <label>Куда (склад/магазин):</label>
    <select id="to-type">
      <option value="store">Магазин</option>
      <option value="warehouse">Склад</option>
    </select>
    <select id="to-store" style="margin-top:0.25rem;"><option value="">— выберите магазин —</option></select>
    <select id="to-warehouse" style="margin-top:0.25rem; display:none;"><option value="">— выберите склад —</option></select>
  </div>
  <div class="form-group">
    <label>Товар:</label>
    <select id="product"><option value="">— выберите —</option></select>
  </div>
  <div class="form-group">
    <label>Количество:</label>
    <input type="number" id="qty" min="1" value="1">
  </div>
  <p id="dist-error" class="error" style="display:none;"></p>
  <div style="display:flex; gap:0.5rem;">
    <button type="button" class="btn btn-secondary" onclick="document.getElementById('dist-error').style.display='none'">Отмена</button>
    <button type="button" class="btn btn-primary" onclick="sendProduct()">Отправить товар</button>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
function loadSelects() {
  fetch('/api/warehouses').then(r=>r.json()).then(whs => {
    var f = document.getElementById('from-warehouse'); f.innerHTML = '<option value="">— выберите —</option>'; whs.forEach(w => { var o = document.createElement('option'); o.value = w.id; o.textContent = w.name; f.appendChild(o); });
    var t = document.getElementById('to-warehouse'); t.innerHTML = '<option value="">— выберите склад —</option>'; whs.forEach(w => { var o = document.createElement('option'); o.value = w.id; o.textContent = w.name; t.appendChild(o); });
  });
  fetch('/api/stores').then(r=>r.json()).then(stores => {
    var s = document.getElementById('to-store'); s.innerHTML = '<option value="">— выберите магазин —</option>'; stores.forEach(st => { var o = document.createElement('option'); o.value = st.id; o.textContent = st.name; s.appendChild(o); });
  });
  fetch('/api/products').then(r=>r.json()).then(prods => {
    var p = document.getElementById('product'); p.innerHTML = '<option value="">— выберите —</option>'; prods.forEach(pr => { var o = document.createElement('option'); o.value = pr.id; o.textContent = pr.name + ' (id: ' + pr.id + ')'; p.appendChild(o); });
  });
}
document.getElementById('to-type').onchange = function() {
  var isStore = this.value === 'store';
  document.getElementById('to-store').style.display = isStore ? 'block' : 'none';
  document.getElementById('to-warehouse').style.display = isStore ? 'none' : 'block';
};
function sendProduct() {
  var fromWh = document.getElementById('from-warehouse').value;
  var toType = document.getElementById('to-type').value;
  var toStore = toType === 'store' ? document.getElementById('to-store').value : null;
  var toWh = toType === 'warehouse' ? document.getElementById('to-warehouse').value : null;
  var productId = document.getElementById('product').value;
  var qty = parseInt(document.getElementById('qty').value, 10) || 0;
  var body = { from_warehouse_id: parseInt(fromWh,10), product_id: parseInt(productId,10), quantity: qty };
  if (toType === 'store') body.to_store_id = parseInt(toStore,10); else body.to_warehouse_id = parseInt(toWh,10);
  if (!fromWh || !productId || qty < 1) { document.getElementById('dist-error').textContent = 'Заполните все поля'; document.getElementById('dist-error').style.display = 'block'; return; }
  fetch('/api/distribution', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
    .then(r=>r.json()).then(data => { if (data.error) { document.getElementById('dist-error').textContent = data.error; document.getElementById('dist-error').style.display = 'block'; } else { document.getElementById('dist-error').style.display = 'none'; document.getElementById('qty').value = 1; alert('Готово'); } });
}
loadSelects();
</script>
{% endblock %}
