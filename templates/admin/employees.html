{% extends "base.html" %}
{% block page_title %}Сотрудники{% endblock %}
{% block content %}
<div class="actions-row">
  <button type="button" class="btn btn-primary" onclick="openAddEmployee()">Добавить сотрудника</button>
</div>
<div class="card">
  <table>
    <thead>
      <tr>
        <th>№</th>
        <th>логин</th>
        <th>ФИО</th>
        <th>роль</th>
        <th>магазин</th>
        <th>активен</th>
      </tr>
    </thead>
    <tbody>
      {% for e in employees_list %}
      <tr class="row-clickable" data-id="{{ e.id }}">
        <td>{{ e.id }}</td>
        <td>{{ e.login }}</td>
        <td>{{ e.full_name }}</td>
        <td>{{ 'администратор' if e.role == 'admin' else 'продавец' }}</td>
        <td>{{ e.store_name or '—' }}</td>
        <td>{{ 'да' if e.active else 'нет' }}</td>
      </tr>
      {% endfor %}
      {% if not employees_list %}
      <tr><td colspan="6">Нет данных</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>
<div id="modal-emp" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:100; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:1.5rem; border-radius:0.5rem; max-width:400px; width:100%;">
    <h3 id="modal-emp-title" style="margin-top:0;">Добавить сотрудника</h3>
    <div class="form-group"><label>Логин</label><input id="emp-login" type="text"></div>
    <div class="form-group" id="emp-password-group"><label>Пароль</label><input id="emp-password" type="password"></div>
    <div class="form-group"><label>ФИО</label><input id="emp-fullname" type="text"></div>
    <div class="form-group"><label>Роль</label><select id="emp-role"><option value="seller">продавец</option><option value="admin">администратор</option></select></div>
    <div class="form-group" id="emp-store-group"><label>Магазин (для продавца)</label><select id="emp-store"><option value="">— выберите —</option></select></div>
    <div class="form-group" id="emp-active-group" style="display:none;"><label><input id="emp-active" type="checkbox"> Активен</label></div>
    <p id="emp-error" class="error" style="display:none;"></p>
    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
      <button type="button" class="btn btn-secondary" id="btn-emp-cancel">Отмена</button>
      <button type="button" class="btn btn-primary" id="btn-emp-save">Сохранить</button>
      <button type="button" class="btn btn-danger" id="btn-emp-delete" style="display:none; margin-left:auto;">Удалить</button>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
var editingEmployeeId = null;
function loadStoresForEmp() {
  fetch('/api/stores', { credentials: 'same-origin' }).then(function(r) { return r.json(); }).then(function(stores) {
    var s = document.getElementById('emp-store');
    s.innerHTML = '<option value="">— выберите —</option>';
    if (Array.isArray(stores)) stores.forEach(function(st) {
      var o = document.createElement('option'); o.value = st.id; o.textContent = st.name; s.appendChild(o);
    });
  }).catch(function() {});
}
loadStoresForEmp();
document.getElementById('emp-role').onchange = function() { document.getElementById('emp-store-group').style.display = this.value === 'seller' ? 'block' : 'none'; };
function openAddEmployee() {
  editingEmployeeId = null;
  document.getElementById('modal-emp-title').textContent = 'Добавить сотрудника';
  document.getElementById('btn-emp-delete').style.display = 'none';
  document.getElementById('emp-password-group').style.display = 'block';
  document.getElementById('emp-active-group').style.display = 'none';
  document.getElementById('emp-login').value = '';
  document.getElementById('emp-login').readOnly = false;
  document.getElementById('emp-password').value = '';
  document.getElementById('emp-fullname').value = '';
  document.getElementById('emp-role').value = 'seller';
  document.getElementById('emp-error').style.display = 'none';
  document.getElementById('modal-emp').style.display = 'flex';
}
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.row-clickable').forEach(function(tr) {
    tr.addEventListener('click', function(e) {
      var id = parseInt(tr.getAttribute('data-id'), 10);
      if (!id) return;
      editingEmployeeId = id;
      document.getElementById('modal-emp-title').textContent = 'Редактировать сотрудника';
      document.getElementById('btn-emp-delete').style.display = 'inline-block';
      document.getElementById('emp-password-group').style.display = 'none';
      document.getElementById('emp-active-group').style.display = 'block';
      document.getElementById('emp-login').readOnly = true;
      var errEl = document.getElementById('emp-error'); errEl.textContent = ''; errEl.style.display = 'none';
      fetch('/api/employees/' + id, { credentials: 'same-origin' }).then(function(r) { return r.json(); }).then(function(data) {
        if (data.error) { errEl.textContent = data.error; errEl.style.display = 'block'; return; }
        document.getElementById('emp-login').value = data.login || '';
        document.getElementById('emp-password').value = '';
        document.getElementById('emp-fullname').value = data.full_name || '';
        document.getElementById('emp-role').value = data.role || 'seller';
        document.getElementById('emp-store').value = data.store_id != null ? String(data.store_id) : '';
        document.getElementById('emp-active').checked = data.active !== false;
        document.getElementById('emp-store-group').style.display = (data.role || 'seller') === 'seller' ? 'block' : 'none';
        document.getElementById('modal-emp').style.display = 'flex';
      }).catch(function() { errEl.textContent = 'Ошибка загрузки'; errEl.style.display = 'block'; });
    });
  });
  document.getElementById('btn-emp-cancel').addEventListener('click', function() { closeModal('modal-emp'); });
  document.getElementById('btn-emp-save').addEventListener('click', function() {
    var login = document.getElementById('emp-login').value.trim();
    var password = document.getElementById('emp-password').value;
    var fullName = document.getElementById('emp-fullname').value.trim();
    var role = document.getElementById('emp-role').value;
    var storeId = role === 'seller' ? document.getElementById('emp-store').value : null;
    var errEl = document.getElementById('emp-error');
    if (!editingEmployeeId) {
      if (!login || !password || !fullName) { errEl.textContent = 'Заполните логин, пароль и ФИО'; errEl.style.display = 'block'; return; }
      if (role === 'seller' && !storeId) { errEl.textContent = 'Выберите магазин для продавца'; errEl.style.display = 'block'; return; }
      fetch('/api/employees', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ login: login, password: password, full_name: fullName, role: role, store_id: storeId ? parseInt(storeId, 10) : null }), credentials: 'same-origin' })
        .then(function(r) { return r.json(); }).then(function(data) {
          if (data.error) { errEl.textContent = data.error; errEl.style.display = 'block'; }
          else { closeModal('modal-emp'); location.reload(); }
        }).catch(function() { errEl.textContent = 'Ошибка сохранения'; errEl.style.display = 'block'; });
    } else {
      if (!fullName) { errEl.textContent = 'Укажите ФИО'; errEl.style.display = 'block'; return; }
      if (role === 'seller' && !storeId) { errEl.textContent = 'Выберите магазин для продавца'; errEl.style.display = 'block'; return; }
      var payload = { full_name: fullName, role: role, store_id: storeId ? parseInt(storeId, 10) : null, active: document.getElementById('emp-active').checked };
      fetch('/api/employees/' + editingEmployeeId, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), credentials: 'same-origin' })
        .then(function(r) { return r.json(); }).then(function(data) {
          if (data.error) { errEl.textContent = data.error; errEl.style.display = 'block'; }
          else { closeModal('modal-emp'); location.reload(); }
        }).catch(function() { errEl.textContent = 'Ошибка сохранения'; errEl.style.display = 'block'; });
    }
  });
  document.getElementById('btn-emp-delete').addEventListener('click', function() {
    if (!editingEmployeeId) return;
    if (!confirm('Удалить этого сотрудника? Запись будет деактивирована.')) return;
    var errEl = document.getElementById('emp-error');
    fetch('/api/employees/' + editingEmployeeId, { method: 'DELETE', credentials: 'same-origin' }).then(function(r) { return r.json(); }).then(function(data) {
      if (data.error) { errEl.textContent = data.error; errEl.style.display = 'block'; }
      else { closeModal('modal-emp'); location.reload(); }
    }).catch(function() { errEl.textContent = 'Ошибка удаления'; errEl.style.display = 'block'; });
  });
});
</script>
{% endblock %}
