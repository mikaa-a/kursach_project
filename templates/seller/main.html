{% extends "base.html" %}
{% block page_title %}Главная страница{% endblock %}
{% block content %}
{% if shift_info %}
<div class="card">
  <h3>Информация о смене</h3>
  <p>Смена открыта с <span id="shift-opened-time">{{ shift_info.opened_iso }}</span></p>
  <p><strong>Время работы:</strong> <span id="shift-counter">—</span> (смена до 12 ч., затем автоматическое закрытие)</p>
</div>
{% else %}
<div class="card">
  <h3>Информация о смене</h3>
  <p>Смена не открыта. Откройте смену для начала работы.</p>
  <button type="button" class="btn btn-primary" onclick="openShift()">Открыть смену</button>
</div>
{% endif %}
{% endblock %}
{% block scripts %}
<script>
function openShift() {
  fetch('/api/shifts/open', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
    .then(r=>r.json()).then(function(data) { if (data.error) alert(data.error); else location.reload(); });
}

(function() {
  var openedEl = document.getElementById('shift-opened-time');
  if (openedEl && openedEl.textContent) {
    try {
      var d = new Date(openedEl.textContent.trim());
      if (!isNaN(d.getTime())) {
        openedEl.textContent = d.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      }
    } catch (e) {}
  }
})();

(function liveShiftCounter() {
  var el = document.getElementById('shift-counter');
  if (!el) return;
  function pad(n) { return n < 10 ? '0' + n : n; }
  function update() {
    fetch('/api/shifts/current')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.closed && data.shift_id) {
          window.location.href = '/seller/shift-report?shift_id=' + data.shift_id;
          return;
        }
        if (data.shift) {
          var h = data.shift.work_hours != null ? data.shift.work_hours : 0;
          var m = data.shift.work_minutes != null ? data.shift.work_minutes : 0;
          el.textContent = pad(h) + ':' + pad(m);
        }
      });
  }
  update();
  setInterval(update, 3000);
})();
</script>
{% endblock %}
