{% extends "base.html" %}
{% block page_title %}Оформление продажи{% endblock %}
{% block content %}
<div style="display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap;">
  <button type="button" class="btn btn-primary" onclick="submitSale()">Оформить продажу</button>
  <button type="button" class="btn btn-secondary" onclick="openReturnModal()">Оформить возврат</button>
</div>
<div class="card">
  <h3>Добавить товар</h3>
  <div class="form-group">
    <label>Товар:</label>
    <select id="product"><option value="">— выберите —</option></select>
  </div>
  <div class="form-group">
    <label>Цена:</label>
    <input type="number" id="price" step="0.01" readonly style="max-width:120px;">
  </div>
  <div class="form-group">
    <label>Количество:</label>
    <input type="number" id="qty" min="1" value="1" style="max-width:100px;">
  </div>
  <button type="button" class="btn btn-primary" onclick="addToReceipt()">Добавить товар в чек</button>
</div>
<div class="card">
  <h3>Товары в чеке</h3>
  <table>
    <thead>
      <tr>
        <th>название</th>
        <th>количество</th>
        <th>цена</th>
        <th>итоговая цена</th>
        <th>удалить</th>
      </tr>
    </thead>
    <tbody id="receipt-tbody">
      <tr><td colspan="5">Нет позиций</td></tr>
    </tbody>
  </table>
  <p id="total-sum">Итого: 0 руб.</p>
</div>
<div style="display:flex; gap:0.5rem;">
  <button type="button" class="btn btn-secondary" onclick="cancelReceipt()">Отменить</button>
</div>
<p id="sale-error" class="error" style="display:none;"></p>

<div id="modal-return" class="modal-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:100; align-items:center; justify-content:center;">
  <div class="modal-content" style="background:#fff; padding:1.5rem; border-radius:0.5rem; max-width:640px; width:100%; margin:1rem;">
    <h3 style="margin-top:0;">Оформление возврата</h3>
    <p class="form-group">
      <label>Дата оформления покупки:</label>
      <input type="date" id="return-date" style="max-width:180px;">
    </p>
    <p class="form-group">
      <button type="button" class="btn btn-secondary" onclick="loadSalesForReturn()">Загрузить продажи за дату</button>
    </p>
    <p class="form-group">
      <label>Выберите продажу:</label>
      <select id="return-sale-select" style="max-width:100%;">
        <option value="">— выберите продажу —</option>
      </select>
    </p>
    <div class="card" style="margin-bottom:1rem;">
      <table>
        <thead>
          <tr>
            <th>Товар</th>
            <th>Продано</th>
            <th>Можно вернуть</th>
            <th>Кол-во к возврату</th>
          </tr>
        </thead>
        <tbody id="return-items-tbody">
          <tr><td colspan="4">Выберите дату и продажу</td></tr>
        </tbody>
      </table>
    </div>
    <p id="return-error" class="error" style="display:none;"></p>
    <div style="display:flex; gap:0.5rem;">
      <button type="button" class="btn btn-secondary" onclick="closeReturnModal()">Закрыть</button>
      <button type="button" class="btn btn-primary" onclick="submitReturn()">Оформить возврат</button>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
var receiptItems = [];
var productsCache = [];
var returnSaleList = [];
var returnSaleItems = [];

fetch('/api/products').then(r=>r.json()).then(function(data) {
  productsCache = data;
  var sel = document.getElementById('product');
  sel.innerHTML = '<option value="">— выберите —</option>';
  data.forEach(function(p) { var o = document.createElement('option'); o.value = p.id; o.textContent = p.name + ' (' + p.retail_price + ' руб.)'; o.dataset.price = p.retail_price; o.dataset.name = p.name; sel.appendChild(o); });
});
document.getElementById('product').onchange = function() {
  var o = this.options[this.selectedIndex];
  document.getElementById('price').value = o.dataset.price || '';
};
function addToReceipt() {
  var sel = document.getElementById('product');
  var pid = sel.value;
  if (!pid) return;
  var o = sel.options[sel.selectedIndex];
  var price = parseFloat(o.dataset.price);
  var name = o.dataset.name;
  var qty = parseInt(document.getElementById('qty').value, 10) || 1;
  receiptItems.push({ product_id: parseInt(pid,10), name: name, quantity: qty, price: price, total: (price * qty).toFixed(2) });
  renderReceipt();
  document.getElementById('qty').value = 1;
}
function removeFromReceipt(i) {
  receiptItems.splice(i, 1);
  renderReceipt();
}
function renderReceipt() {
  var tbody = document.getElementById('receipt-tbody');
  if (receiptItems.length === 0) { tbody.innerHTML = '<tr><td colspan="5">Нет позиций</td></tr>'; document.getElementById('total-sum').textContent = 'Итого: 0 руб.'; return; }
  var html = '';
  var total = 0;
  receiptItems.forEach(function(it, i) {
    total += it.price * it.quantity;
    html += '<tr><td>' + it.name + '</td><td>' + it.quantity + '</td><td>' + it.price.toFixed(2) + '</td><td>' + (it.price * it.quantity).toFixed(2) + '</td><td><button type="button" class="btn btn-sm btn-danger" onclick="removeFromReceipt(' + i + ')">удалить</button></td></tr>';
  });
  tbody.innerHTML = html;
  document.getElementById('total-sum').textContent = 'Итого: ' + total.toFixed(2) + ' руб.';
}
function cancelReceipt() {
  receiptItems = [];
  renderReceipt();
  document.getElementById('sale-error').style.display = 'none';
}
function submitSale() {
  if (receiptItems.length === 0) { document.getElementById('sale-error').textContent = 'Добавьте товары в чек'; document.getElementById('sale-error').style.display = 'block'; return; }
  document.getElementById('sale-error').style.display = 'none';
  var items = receiptItems.map(function(it) { return { product_id: it.product_id, quantity: it.quantity }; });
  fetch('/api/sales', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: items }) })
    .then(r=>r.json())
    .then(function(data) {
      if (data.error) { document.getElementById('sale-error').textContent = data.error; document.getElementById('sale-error').style.display = 'block'; return; }
      cancelReceipt();
      alert('Продажа оформлена. Сумма: ' + data.total.toFixed(2) + ' руб.');
    });
}

function openReturnModal() {
  document.getElementById('return-date').value = '';
  document.getElementById('return-sale-select').innerHTML = '<option value="">— выберите продажу —</option>';
  document.getElementById('return-items-tbody').innerHTML = '<tr><td colspan="4">Выберите дату и продажу</td></tr>';
  document.getElementById('return-error').style.display = 'none';
  returnSaleList = [];
  returnSaleItems = [];
  document.getElementById('modal-return').style.display = 'flex';
}
function closeReturnModal() {
  document.getElementById('modal-return').style.display = 'none';
}
function loadSalesForReturn() {
  var date = document.getElementById('return-date').value;
  if (!date) { document.getElementById('return-error').textContent = 'Укажите дату покупки'; document.getElementById('return-error').style.display = 'block'; return; }
  document.getElementById('return-error').style.display = 'none';
  fetch('/api/sales/by-store-date?date=' + encodeURIComponent(date)).then(r=>r.json()).then(function(data) {
    returnSaleList = Array.isArray(data) ? data : [];
    var sel = document.getElementById('return-sale-select');
    sel.innerHTML = '<option value="">— выберите продажу —</option>';
    returnSaleList.forEach(function(s) {
      var t = s.created_at ? s.created_at.slice(11, 19) : '';
      var o = document.createElement('option');
      o.value = s.id;
      o.textContent = '№' + s.id + ' ' + t + ' — ' + (s.total_revenue != null ? s.total_revenue.toFixed(2) : '0') + ' руб.';
      sel.appendChild(o);
    });
    returnSaleItems = [];
    document.getElementById('return-items-tbody').innerHTML = '<tr><td colspan="4">Выберите продажу</td></tr>';
  });
}
document.getElementById('return-sale-select').onchange = function() {
  var id = this.value;
  if (!id) { returnSaleItems = []; document.getElementById('return-items-tbody').innerHTML = '<tr><td colspan="4">Выберите продажу</td></tr>'; return; }
  fetch('/api/operations/' + id + '/items').then(r=>r.json()).then(function(data) {
    if (data.error) { document.getElementById('return-error').textContent = data.error; document.getElementById('return-error').style.display = 'block'; return; }
    returnSaleItems = (Array.isArray(data) ? data : []).map(function(row) {
      var rem = row.remaining != null ? row.remaining : (row.quantity - (row.already_returned || 0));
      return { product_id: row.product_id, product_name: row.product_name, sold_qty: row.quantity, already_returned: row.already_returned || 0, remaining: rem, return_qty: 0 };
    });
    var tbody = document.getElementById('return-items-tbody');
    if (returnSaleItems.length === 0) { tbody.innerHTML = '<tr><td colspan="4">В этой продаже нет позиций или всё уже возвращено</td></tr>'; return; }
    var html = '';
    returnSaleItems.forEach(function(it, i) {
      var canReturn = it.remaining || 0;
      var soldInfo = it.sold_qty + (it.already_returned ? ' (возвращено ' + it.already_returned + ')' : '');
      html += '<tr><td>' + (it.product_name || '') + '</td><td>' + soldInfo + '</td><td>до ' + canReturn + '</td><td><input type="number" id="return-qty-' + i + '" min="0" max="' + canReturn + '" value="0" style="max-width:80px;" onchange="updateReturnQty(' + i + ')"></td></tr>';
    });
    tbody.innerHTML = html;
  });
};
function updateReturnQty(i) {
  var el = document.getElementById('return-qty-' + i);
  if (!el) return;
  var v = parseInt(el.value, 10) || 0;
  var max = returnSaleItems[i] ? (returnSaleItems[i].remaining || 0) : 0;
  if (v > max) { el.value = max; v = max; }
  if (returnSaleItems[i]) returnSaleItems[i].return_qty = v;
}
function submitReturn() {
  var saleId = document.getElementById('return-sale-select').value;
  if (!saleId) { document.getElementById('return-error').textContent = 'Выберите продажу'; document.getElementById('return-error').style.display = 'block'; return; }
  for (var i = 0; i < returnSaleItems.length; i++) {
    var el = document.getElementById('return-qty-' + i);
    if (el) returnSaleItems[i].return_qty = parseInt(el.value, 10) || 0;
  }
  var items = returnSaleItems.filter(function(it) { return it.return_qty > 0; }).map(function(it) { return { product_id: it.product_id, quantity: it.return_qty }; });
  if (items.length === 0) { document.getElementById('return-error').textContent = 'Укажите количество товаров для возврата'; document.getElementById('return-error').style.display = 'block'; return; }
  document.getElementById('return-error').style.display = 'none';
  fetch('/api/returns', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ original_operation_id: parseInt(saleId, 10), items: items }) })
    .then(function(r) {
      return r.text().then(function(text) {
        var data;
        try { data = text ? JSON.parse(text) : {}; } catch (e) { data = { error: 'Ответ сервера: ' + (text ? text.slice(0, 200) : r.status) }; }
        if (!r.ok) {
          document.getElementById('return-error').textContent = data.error || ('Ошибка ' + r.status);
          document.getElementById('return-error').style.display = 'block';
          return;
        }
        if (data.error) {
          document.getElementById('return-error').textContent = data.error;
          document.getElementById('return-error').style.display = 'block';
          return;
        }
        closeReturnModal();
        alert('Возврат оформлен. Сумма возврата: ' + (data.total != null ? data.total.toFixed(2) : '0') + ' руб. Товар возвращён в остатки магазина.');
      });
    })
    .catch(function(e) {
      document.getElementById('return-error').textContent = 'Ошибка сети или сервера: ' + (e.message || e);
      document.getElementById('return-error').style.display = 'block';
    });
}
</script>
{% endblock %}
